{% extends "base.html" %}
{% block body %}
    <script>
        function fetchBooks(event) {
            event.preventDefault(); // Prevents page reload

            let formData = new FormData(document.getElementById("bookForm"));
            
            fetch("/books_api", {
                method: "POST",
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                document.body.innerHTML = html; // Replace page content with new response
            })
            .catch(error => console.error("Error fetching books:", error));
        }
    </script>
</head>
<body>
    <h2>Import Books</h2>
    <form id="bookForm" method="POST" action="/books_api" onsubmit="fetchBooks(event)">
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required>

        <label for="authors">Authors:</label>
        <input type="text" id="authors" name="authors">

        <label for="isbn">ISBN:</label>
        <input type="text" id="isbn" name="isbn">

        <label for="publisher">Publisher:</label>
        <input type="text" id="publisher" name="publisher">

        <label for="required_books">Number of Books:</label>
        <input type="number" id="required_books" name="required_books" min="1" required>

        <button type="submit">Fetch Books</button>
    </form>

    {% if books %}
    <h3>Fetched Books</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Book Name</th>
                <th>Authors</th>
                <th>ISBN</th>
                <th>Publisher</th>
                <th>Number of Times Fetched</th>
            </tr>
        </thead>
        <tbody>
            {% set book_counts = {} %}
            
            {% for book in books %}
                {% set title = book["title"] %}
                {% set authors = book.get("authors", "Unknown") %}
                {% set isbn = book.get("isbn", "N/A") %}
                {% set publisher = book.get("publisher", "N/A") %}
                
                {% set key = (title, authors, isbn, publisher) %}
                
                {% if key in book_counts %}
                    {% set _ = book_counts.update({key: book_counts[key] + 1}) %}
                {% else %}
                    {% set _ = book_counts.update({key: 1}) %}
                {% endif %}
            {% endfor %}
            
            {% for (title, authors, isbn, publisher), count in book_counts.items() %}
                <tr>
                    <td>{{ title }}</td>
                    <td>{{ authors }}</td>
                    <td>{{ isbn }}</td>
                    <td>{{ publisher }}</td>
                    <td>{{ count }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}


{% endblock %}