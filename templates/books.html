{% extends "base.html" %}

{% block body %}
<div class="container mt-4">
    <h2 class="mb-3">ðŸ“š Library Books</h2>

    <div class="d-flex justify-content-between mb-3">
        <a class="btn btn-primary" href="/books_api">+ Import Books</a>
        <a class="btn btn-success" href="/download-books-csv">ðŸ“¥ Download CSV</a>
        
        <!-- Filter Dropdowns -->
        <div class="d-flex">
            <select id="filterLanguage" class="form-select mx-2">
                <option value="">All Languages</option>
                {% for book in books | groupby('language') %}
                <option value="{{ book.grouper }}">{{ book.grouper }}</option>
                {% endfor %}
            </select>

            <select id="filterPublisher" class="form-select mx-2">
                <option value="">All Publishers</option>
                {% for book in books | groupby('publisher') %}
                <option value="{{ book.grouper }}">{{ book.grouper }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Search & Sort Bar -->
    <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search books...">
        <button class="btn btn-outline-secondary" id="sortTitle">Sort by Title</button>
        <button class="btn btn-outline-secondary" id="sortAuthor">Sort by Author</button>
        <button class="btn btn-outline-secondary" id="sortStock">Sort by Stock</button>
    </div>

    <!-- Books Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Select</th>
                    <th>Cover</th>
                    <th>Name of Book</th>
                    <th>Author Name</th>
                    <th>Current Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="booksTable">
                {% for book in books %}
                <tr class="book-row" data-language="{{ book.language }}" data-publisher="{{ book.publisher }}">
                    <td><input type="checkbox" class="book-checkbox" value="{{ book.id }}"></td>
                    <td><img src="{{ book.cover_url or '/static/default_cover.jpg' }}" alt="Cover" width="50"></td>
                    <td>{{ book.title }}</td>
                    <td>{{ book.author }}</td>
                    <td class="stock-cell" data-stock="{{ book.stock }}">{{ book.stock }}</td>
                    <td>
                        <a href="/create-transaction" class="btn btn-primary btn-sm">
                            <i class="bi bi-file-earmark-text"></i> Issue/Return
                        </a>
                        <a href="/edit-books/{{ book.id }}" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href="/delete-book/{{ book.id }}" class="btn btn-danger btn-sm delete-book" data-id="{{ book.id }}">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button class="btn btn-danger mt-3" id="bulkDeleteBtn">Delete Selected</button>
</div>

<script>
    // Search Filter
    document.getElementById("searchInput").addEventListener("keyup", function () {
        let input = this.value.toLowerCase();
        let rows = document.querySelectorAll(".book-row");

        rows.forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
        });
    });

    // Sorting Books
    let sortOrder = {
        title: 1,
        author: 1,
        stock: 1
    };

    function sortTable(columnIndex, key, dataType) {
        let table = document.getElementById("booksTable");
        let rows = Array.from(table.getElementsByClassName("book-row"));

        rows.sort((a, b) => {
            let valA = a.children[columnIndex].innerText.trim();
            let valB = b.children[columnIndex].innerText.trim();

            if (dataType === "number") {
                valA = parseInt(valA);
                valB = parseInt(valB);
            }

            return sortOrder[key] * (valA > valB ? 1 : -1);
        });

        // Toggle order for next click
        sortOrder[key] *= -1;

        // Reorder rows in the table
        rows.forEach(row => table.appendChild(row));
    }

    document.getElementById("sortTitle").addEventListener("click", () => sortTable(2, "title", "text"));
    document.getElementById("sortAuthor").addEventListener("click", () => sortTable(3, "author", "text"));
    document.getElementById("sortStock").addEventListener("click", () => sortTable(4, "stock", "number"));

    document.getElementById("sortTitle").addEventListener("click", () => sortTable(2, "text"));
    document.getElementById("sortAuthor").addEventListener("click", () => sortTable(3, "text"));
    document.getElementById("sortStock").addEventListener("click", () => sortTable(4, "number"));

    // Highlight low stock books
    document.querySelectorAll(".stock-cell").forEach(cell => {
        if (parseInt(cell.dataset.stock) < 5) {
            cell.style.color = "red";
            cell.style.fontWeight = "bold";
        }
    });

    // Bulk Delete Books
    document.getElementById("bulkDeleteBtn").addEventListener("click", function () {
        let selectedBooks = [...document.querySelectorAll(".book-checkbox:checked")];
        
        if (selectedBooks.length === 0) {
            alert("No books selected!");
            return;
        }

        // Collect book details for confirmation message
        let bookDetails = selectedBooks.map(cb => {
            let row = cb.closest("tr");
            let title = row.querySelector("td:nth-child(3)").innerText.trim();
            let stock = row.querySelector("td:nth-child(5)").innerText.trim();
            return `â€¢ ${title} (Stock: ${stock})`;
        }).join("\n");

        let confirmDelete = confirm(`Do you really want to delete the following books?\n\n${bookDetails}`);
        if (!confirmDelete) return;

        let bookIds = selectedBooks.map(cb => cb.value);

        fetch("/delete-books", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ book_ids: bookIds })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(error => console.error("Error:", error));
    });


    // Individual Book Delete
    document.querySelectorAll(".delete-book").forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();  // Prevent default link behavior
            let bookId = this.dataset.id;
            let bookRow = this.closest("tr");
            let bookTitle = bookRow.querySelector("td:nth-child(3)").innerText.trim();
            let stock = bookRow.querySelector("td:nth-child(5)").innerText.trim();

            let confirmDelete = confirm(`Do you really want to delete all ${stock} instance of book "${bookTitle}"?`);
            if (!confirmDelete) return;

            fetch(`/delete-book/${bookId}`, { method: "DELETE" })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();  // Refresh the page after deletion
            })
            .catch(error => console.error("Error:", error));
        });
    });


    // Filter Books by Language and Publisher
    function applyFilters() {
        let selectedLanguage = document.getElementById("filterLanguage").value;
        let selectedPublisher = document.getElementById("filterPublisher").value;

        document.querySelectorAll(".book-row").forEach(row => {
            let matchesLanguage = selectedLanguage === "" || row.dataset.language === selectedLanguage;
            let matchesPublisher = selectedPublisher === "" || row.dataset.publisher === selectedPublisher;

            row.style.display = matchesLanguage && matchesPublisher ? "" : "none";
        });
    }

    document.getElementById("filterLanguage").addEventListener("change", applyFilters);
    document.getElementById("filterPublisher").addEventListener("change", applyFilters);
</script>

{% endblock %}
